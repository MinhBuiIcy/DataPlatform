#!/bin/bash
# Pre-push hook for DataPlatform
# Checks for secrets, runs tests, and lints code before push

set -e  # Exit on first error

echo "üîí Pre-push checks running..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Step 1: Check for API keys and secrets
echo ""
echo "üîç Checking for API keys and secrets..."

# Known safe/fake credentials to ignore (LocalStack, tests)
SAFE_CREDENTIALS=(
    "test"
    "fake"
    "dummy"
    "example"
    "your_key_here"
    "localstack"
    "mock"
)

# Patterns to search for
PATTERNS=(
    "api[_-]?key.*=.*['\"][^'\"]{20,}"
    "secret.*=.*['\"][^'\"]{20,}"
    "password.*=.*['\"][^'\"]{10,}"
    "aws_access_key_id.*=.*['\"][A-Z0-9]{16,}"
    "aws_secret_access_key.*=.*['\"][A-Za-z0-9/+=]{32,}"
    "AKIA[0-9A-Z]{16}"  # AWS Access Key
    "sk-[a-zA-Z0-9]{32,}"  # OpenAI API key pattern
)

# Files to exclude
EXCLUDE_PATTERNS=(
    ".env.example"
    ".env.terraform"
    "*.md"
    "*.pyc"
    "__pycache__"
    ".git"
    "scripts/hooks"
)

# Build exclude arguments for grep
EXCLUDE_ARGS=""
for pattern in "${EXCLUDE_PATTERNS[@]}"; do
    EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$pattern"
done

SECRETS_FOUND=0
for pattern in "${PATTERNS[@]}"; do
    # Search in tracked files only
    MATCHES=$(git diff --cached --name-only | grep -E '\.(py|yaml|yml|json|sh|env)$' | xargs grep -i -E "$pattern" $EXCLUDE_ARGS 2>/dev/null || true)

    if [ -n "$MATCHES" ]; then
        # Filter out safe credentials (LocalStack tokens, test keys, etc.)
        FILTERED_MATCHES=$(echo "$MATCHES" | grep -v "ls-" | grep -v "test" | grep -v "localstack" | grep -v "fake" | grep -v "dummy" || true)

        if [ -n "$FILTERED_MATCHES" ]; then
            echo "$FILTERED_MATCHES"
            SECRETS_FOUND=1
        fi
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${RED}‚ùå Potential API keys or secrets detected!${NC}"
    echo -e "${YELLOW}Please remove sensitive data before pushing.${NC}"
    echo -e "${YELLOW}If this is a false positive, update the hook in scripts/hooks/pre-push${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì No secrets detected${NC}"

# Step 2: Run ruff linting
echo ""
echo "üßπ Running ruff linter..."

if ! uv run ruff check . --fix; then
    echo -e "${RED}‚ùå Ruff linting failed!${NC}"
    echo -e "${YELLOW}Fix the issues above before pushing.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì Ruff linting passed${NC}"

# Step 3: Run ruff formatting check
echo ""
echo "üé® Checking code formatting..."

if ! uv run ruff format --check .; then
    echo -e "${YELLOW}‚ö† Code formatting issues detected!${NC}"
    echo -e "${YELLOW}Run 'uv run ruff format .' to auto-format${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì Code formatting is correct${NC}"

# Step 4: Run unit tests
echo ""
echo "üß™ Running unit tests..."

if ! uv run pytest tests/unit/ -v --tb=short; then
    echo -e "${RED}‚ùå Unit tests failed!${NC}"
    echo -e "${YELLOW}Fix the failing tests before pushing.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì All unit tests passed${NC}"

# Success
echo ""
echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"
echo -e "${GREEN}üöÄ Proceeding with push...${NC}"
echo ""

exit 0
