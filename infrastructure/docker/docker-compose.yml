version: '3.8'

# ============================================
# ENVIRONMENT VARIABLES
# Docker Compose automatically loads .env from:
# 1. Same directory as docker-compose.yml
# 2. Project root (if run with -f flag)
# We use root .env file for single source of truth
# ============================================

# ============================================
# NETWORKS
# ============================================
networks:
  trading-net:
    driver: bridge
    name: trading-network

# ============================================
# VOLUMES (Data Persistence)
# ============================================
volumes:
  localstack-data:
    name: trading-localstack-data
  clickhouse-data:
    name: trading-clickhouse-data
  redis-data:
    name: trading-redis-data
  postgres-data:
    name: trading-postgres-data
  grafana-data:
    name: trading-grafana-data
  kafka-data:
    name: trading-kafka-data
  prometheus-data:
    name: trading-prometheus-data

# ============================================
# SERVICES
# ============================================
services:
  # ============================================
  # LOCALSTACK - AWS Services Emulation
  # ============================================
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack-pro
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # External services port range
      - "127.0.0.1:443:443"              # LocalStack HTTPS Gateway (Pro)
    environment:
      # Activate LocalStack Pro
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN:?}
      # LocalStack configuration
      - DEBUG=${DEBUG:-0}
      - PERSISTENCE=${PERSISTENCE:-1}   # Enable persistence
      - LAMBDA_EXECUTOR=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - localstack-data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # CLICKHOUSE - Time-Series Database
  # ============================================
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: trading-clickhouse
    hostname: clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse/config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-trading}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-trading_user}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-trading_pass}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # CLICKHOUSE INIT - Schema & Migrations
  # ============================================
  clickhouse-init:
    image: clickhouse/clickhouse-server:24.1
    container_name: trading-clickhouse-init
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - trading-net
    volumes:
      - ./clickhouse/init.sql:/init/init.sql:ro
      - ./clickhouse/migrations:/migrations:ro
      - ./clickhouse/init-and-migrate.sh:/init-and-migrate.sh:ro
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 9000
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-trading_user}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-trading_pass}
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-trading}
    entrypoint: ["bash", "/init-and-migrate.sh"]
    restart: "no"

  # ============================================
  # REDIS - In-Memory Cache
  # ============================================
  redis:
    image: redis:7.2-alpine
    container_name: trading-redis
    hostname: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # POSTGRESQL - Relational Database
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: trading-postgres
    hostname: postgres
    ports:
      - "5433:5432"  # Changed to 5433 to avoid conflict with local PostgreSQL
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-trading}
      POSTGRES_USER: ${POSTGRES_USER:-trading_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-trading_pass}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    networks:
      - trading-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-trading_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # ============================================
  # PROMETHEUS - Metrics Collection
  # ============================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: trading-prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
      - ../../monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ============================================
  # GRAFANA - Monitoring & Visualization
  # ============================================
  grafana:
    image: grafana/grafana:10.3.0
    container_name: trading-grafana
    hostname: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ../../monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ../../monitoring/grafana/provisioning:/etc/grafana/provisioning/datasources:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clickhouse-datasource,redis-datasource
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
    networks:
      - trading-net
    depends_on:
      clickhouse-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # KAFKA - Event Streaming Platform (KRaft Mode)
  # ============================================
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: trading-kafka
    hostname: kafka
    ports:
      - "9092:9092"  # INTERNAL listener (Docker network)
      - "9094:9094"  # EXTERNAL listener (localhost)
    environment:
      # KRaft mode configuration (no ZooKeeper needed)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Dual listeners: INTERNAL (Docker) + EXTERNAL (localhost)
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # Cluster configuration (must be valid UUID for KRaft mode)
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

      # Topic defaults
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

      # Retention & performance
      KAFKA_LOG_RETENTION_HOURS: 24
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 3

      # KRaft specific
      KAFKA_LOG_DIRS: /var/lib/kafka/data
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - trading-net
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # KAFKA INIT - Topic Creation
  # ============================================
  kafka-init:
    image: confluentinc/cp-kafka:7.6.0
    container_name: trading-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - trading-net
    volumes:
      - ./kafka/create-topics.sh:/tmp/create-topics.sh:ro
    command: >
      bash -c "/tmp/create-topics.sh"
    restart: "no"

  # ============================================
  # MARKET DATA INGESTION SERVICE (Phase 1)
  # ============================================
  market-data-ingestion:
    build:
      context: ../..
      dockerfile: services/market_data_ingestion/Dockerfile
    container_name: trading-market-data-ingestion
    hostname: market-data-ingestion
    env_file:
      - ../../.env  # Load secrets from .env
    environment:
      # Override only container-specific values
      # All other configs loaded from config/providers/*.yaml
      - CLOUD_PROVIDER=${CLOUD_PROVIDER:-opensource}
    volumes:
      # Mount code for hot reload (development only)
      - ../../core:/app/core:ro
      - ../../domain:/app/domain:ro
      - ../../factory:/app/factory:ro
      - ../../providers:/app/providers:ro
      - ../../services/market_data_ingestion:/app/services/market_data_ingestion:ro
      - ../../config:/app/config:ro  # Config last to ensure proper override
      - ../../data/logs:/app/data/logs  # Error log files (RotatingFileHandler)
    networks:
      - trading-net
    depends_on:
      clickhouse-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - services  # Start with: docker-compose --profile services up

  # ============================================
  # INDICATOR SERVICE (Phase 2)
  # ============================================
  indicator-service:
    build:
      context: ../..
      dockerfile: services/indicator_service/Dockerfile
      args:
        TALIB_BASE_IMAGE: trading-platform/talib-base:3.11
    container_name: trading-indicator-service
    hostname: indicator-service
    env_file:
      - ../../.env  # Load secrets from .env
    environment:
      # Override only container-specific values
      # All other configs loaded from config/providers/*.yaml
      - CLOUD_PROVIDER=${CLOUD_PROVIDER:-opensource}
    volumes:
      # Mount config directory (read-only)
      - ../../config:/app/config:ro
      # Mount code for hot reload (development only)
      - ../../core:/app/core:ro
      - ../../domain:/app/domain:ro
      - ../../factory:/app/factory:ro
      - ../../providers:/app/providers:ro
      - ../../services/indicator_service:/app/services/indicator_service:ro
      - ../../data/logs:/app/data/logs  # Error log files (RotatingFileHandler)
    networks:
      - trading-net
    depends_on:
      clickhouse-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - services  # Start with: docker-compose --profile services up

  # ============================================
  # BACKFILL SERVICE (Phase 2)
  # ============================================
  sync-service:
    build:
      context: ../..
      dockerfile: services/sync_service/Dockerfile
    container_name: trading-sync-service
    hostname: sync-service
    env_file:
      - ../../.env  # Load secrets from .env
    environment:
      - CLOUD_PROVIDER=${CLOUD_PROVIDER:-opensource}
    volumes:
      - ../../config:/app/config:ro
      - ../../core:/app/core:ro
      - ../../domain:/app/domain:ro
      - ../../factory:/app/factory:ro
      - ../../providers:/app/providers:ro
      - ../../services/sync_service:/app/services/sync_service:ro
      - ../../data/logs:/app/data/logs  # Error log files (RotatingFileHandler)
    networks:
      - trading-net
    depends_on:
      clickhouse-init:
        condition: service_completed_successfully
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - services  # Start with: docker-compose --profile services up

  # ============================================
  # REDIS COMMANDER (Optional - Redis GUI)
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: trading-redis-commander
    hostname: redis-commander
    ports:
      - "8081:8081"
    environment:
      REDIS_HOSTS: local:redis:6379
    networks:
      - trading-net
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
